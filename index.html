<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2"/>
    <title>pika shot</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, getDocs, serverTimestamp, updateDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKu623PDECcc1gYVe4xof6AVUxDlW7B_A",
            authDomain: "pika-shot.firebaseapp.com",
            projectId: "pika-shot",
            storageBucket: "pika-shot.firebasestorage.app",
            messagingSenderId: "221719282655",
            appId: "1:221719282655:web:fefc576166eeb115077a6a"
        };

        // Initialize Firebase and attach to window for access in other scripts
        const app = initializeApp(firebaseConfig);
        window.fb = {
            auth: getAuth(app),
            db: getFirestore(app),
            signInAnonymously,
            collection,
            doc,
            getDoc,
            setDoc,
            getDocs,
            updateDoc,
            serverTimestamp,
            onSnapshot,
            query
        };
    </script>
</head>
<body>

    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <p>pika shot</p>
        <div id="loader-check" class="loader-check" style="display: none;">✔</div>
    </div>

    <div id="app-container" class="app-container" style="display: none;">

        <div id="onboarding-view" class="view">
            <div class="onboarding-content">
                <h1>Welcome to pika shot</h1>
                <p>The simplest way to track your sales and inventory.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-name">Your Name</label>
                        <input type="text" id="user-name" placeholder="e.g., Chiamaka" required>
                    </div>
                    <div class="form-group">
                        <label for="business-name">Business Name</label>
                        <input type="text" id="business-name" placeholder="e.g., Amaka's Provisions" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="user-phone">Phone Number</label>
                    <input type="tel" id="user-phone" placeholder="e.g., 08012345678" maxlength="11" required>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label for="business-type">Business Type</label>
                        <select id="business-type" required>
                            <option value="" disabled selected>Select your type</option>
                            <option value="Retailer">Retailer</option>
                            <option value="Wholesaler">Wholesaler</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="business-location">Location</label>
                        <select id="business-location" required>
                            <option value="" disabled selected>Select your area</option>
                            <option value="Lagos Island">Lagos Island</option>
                            <option value="Ikeja">Ikeja</option>
                            <option value="Yaba">Yaba</option>
                            <option value="Surulere">Surulere</option>
                            <option value="Lekki">Lekki</option>
                            <option value="Apapa">Apapa</option>
                        </select>
                    </div>
                </div>
                <button id="start-onboarding-btn" class="btn btn-primary">Get Started</button>
                <p class="privacy-policy-link">By using Pika-Shot, you agree to our <a href="#" id="privacy-link">Data & Privacy Policy</a>.</p>
            </div>
        </div>
        
        <div id="location-permission-view" class="view">
             <div class="onboarding-content">
                <div class="permission-icon">
                   <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </div>
                <h2>Location Access</h2>
                <p>pika shot uses your location to provide relevant insights. Please allow access to continue.</p>
                <button id="grant-location-btn" class="btn btn-primary">Allow Location</button>
            </div>
        </div>

        <div id="camera-permission-view" class="view">
            <div class="onboarding-content">
                <div class="permission-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </div>
                <h2>Camera Access</h2>
                <p>pika shot uses your camera to scan product barcodes instantly. This makes adding items and selling faster than ever. Please allow access to continue.</p>
                <button id="grant-camera-btn" class="btn btn-primary">Allow Camera</button>
            </div>
        </div>

        <header id="app-header" class="app-header" style="display: none;">
             <button id="back-btn" class="back-btn" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
             </button>
             <h1 id="header-title">Home</h1>
             <button id="add-to-homescreen-btn" class="add-to-homescreen-btn" style="display: none;">Install app</button>
        </header>

        <main id="main-content" class="main-content" style="display: none;">
            
            <div id="home-view" class="view page">
                <div class="home-header">
                    <p id="welcome-date"></p>
                    <h2 id="welcome-name">Welcome!</h2>
                </div>

                <div id="home-content" class="home-content">
                    <div id="home-dashboard-content">
                        <div class="dashboard-grid">
                            <div class="card stat-card">
                                <div class="stat-icon sales">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                                </div>
                                <p>Today's Sales</p>
                                <h3 id="total-sales">₦0</h3>
                            </div>
                            <div class="card stat-card">
                                <div class="stat-icon items">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                                </div>
                                <p>Items Sold</p>
                                <h3 id="items-sold">0</h3>
                            </div>
                        </div>

                        <div id="see-stock-levels-container" class="see-all-container" style="display: none; margin-top: 24px; margin-bottom: 0;">
                            <button id="see-stock-levels-btn" class="see-all-btn">See customers stock levels <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="arrow-icon"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                        </div>
                        
                        <div class="recent-sales-container">
                            <div class="recent-sales-header">
                                <h4>Recent Sales</h4>
                                <p id="selection-mode-hint" class="selection-hint">Long-press to select</p>
                            </div>
                            <div id="recent-sales-list">
                                </div>
                            <div id="see-all-container" class="see-all-container" style="display: none;">
                                <button id="see-all-sales-btn" class="see-all-btn">See All <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="arrow-icon"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="products-view" class="view page">
                <div class="product-header">
                    <p id="product-sku-count" class="sku-count"></p>
                </div>
                <div id="product-search-container" style="display: none;">
                    <input type="search" id="product-search-input" placeholder="Search my products...">
                </div>
                <div id="product-grid" class="product-grid">
                     <p class="empty-state">No products added yet. Tap "Add Product" to get started!</p>
                </div>
                <button id="add-new-product-btn" class="fab disabled">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>

            <div id="all-sales-view" class="view page">
                <div id="all-sales-list" class="all-sales-container">
                    </div>
            </div>

            <div id="stock-levels-view" class="view page">
                <div class="page-actions-header">
                    <button id="refresh-stocks-btn" class="btn-icon-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        <span>Refresh</span>
                    </button>
                </div>
                <div id="retailer-stock-view" class="all-sales-container">
                    </div>
            </div>

        </main>

        <nav id="bottom-nav" class="bottom-nav" style="display: none;">
            <button class="nav-btn active" data-view="home-view">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>Home</span>
            </button>
            <button id="sell-item-btn-main" class="nav-btn-main disabled">
                 <div class="nav-btn-loader"></div>
                 <svg class="nav-btn-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a1 1 0 0 1-1.41 0l-7.17-7.17a1 1 0 0 1 0-1.41l7.17-7.17a1 1 0 0 1 1.41 0l7.17 7.17a1 1 0 0 1 0 1.41z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                <span id="sell-item-btn-text">Sell Item</span>
            </button>
            <button class="nav-btn" data-view="products-view">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                <span>Products</span>
            </button>
        </nav>
        
        <div id="receipt-actions" class="receipt-actions">
            <button id="cancel-selection-btn" class="btn btn-secondary">Cancel</button>
            <button id="generate-receipt-btn" class="btn btn-primary" disabled>Generate Receipt</button>
            <button id="share-log-btn" class="btn btn-primary" style="display: none;">Share as Log</button>
        </div>

        <div id="camera-view" class="view camera-container">
            <video id="camera-feed" playsinline></video>
            <div id="camera-overlay" class="camera-overlay">
                <div class="scan-box"></div>
                <p id="scan-feedback">Scanning...</p>
                <div id="scan-timer-display" class="scan-timer-display">3</div>
            </div>
            <button id="cancel-scan-btn" class="btn btn-secondary cancel-scan-btn">Cancel</button>
        </div>

    </div> 
    
    <div id="modal-container" class="modal-container" style="display:none;">

        <div id="add-product-failed-modal" class="modal-content" style="display:none;">
            <h2>Scan Failed</h2>
            <p>No barcode was detected. Please ensure the barcode is clear and well-lit.</p>
            <div class="modal-actions modal-actions-inline">
                <button id="cancel-add-scan-btn" class="btn btn-secondary">Cancel</button>
                <button id="retry-add-scan-btn" class="btn btn-primary">Try Again</button>
            </div>
        </div>

        <div id="product-exists-modal" class="modal-content" style="display:none;">
            <h2>Product Exists</h2>
            <p id="product-exists-message">This product is already in your inventory.</p>
            <div class="modal-actions">
                <button id="product-exists-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>

        <div id="confirm-picture-modal" class="modal-content" style="display:none;">
            <h2>Confirm Picture</h2>
            <img id="captured-image-preview" src="" alt="Captured product image">
            <div class="modal-actions">
                <div class="modal-actions-inline">
                    <button id="cancel-picture-btn" class="btn btn-secondary">Cancel</button>
                    <button id="retake-picture-btn" class="btn btn-secondary">Try Again</button>
                </div>
                <button id="confirm-picture-btn" class="btn btn-primary">Confirm</button>
            </div>
        </div>

        <div id="product-form-modal" class="modal-content" style="display:none;">
            <button id="delete-product-btn" class="delete-btn-icon" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
            <h2 id="product-form-title">Add New Product</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <p id="product-source-info" class="source-info" style="display: none;"></p>
                <p id="product-barcode-display" class="barcode-display" style="display: none;"></p>
                <div class="form-group">
                     <button type="button" id="scan-new-barcode-btn" class="btn btn-secondary scan-new-barcode-btn" style="display: none;">Scan Barcode</button>
                </div>
                <div class="form-group">
                    <button type="button" id="add-change-picture-btn" class="btn btn-secondary">Add / Change Picture</button>
                </div>
                <div class="form-group"><label for="product-name">Product Name</label><input type="text" id="product-name" required></div>
                <div class="form-group"><label for="product-price">Selling Price (₦)</label><input type="text" id="product-price" inputmode="decimal" required></div>
                <div class="form-row">
                    <div class="form-group"><label for="product-stock">Stock Quantity</label><input type="text" id="product-stock" inputmode="numeric" required></div>
                    <div class="form-group"><label for="product-unit">Unit Type</label><select id="product-unit" required><option value="sachets">sachets</option><option value="bottles">bottles</option><option value="cans">cans</option><option value="pieces">pieces</option><option value="packs">packs</option><option value="cartons" class="wholesaler-only">cartons</option></select></div>
                </div>
                <div class="modal-actions"><button type="button" id="cancel-product-form-btn" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Save Product</button></div>
            </form>
        </div>
        
        <div id="carton-details-modal" class="modal-content" style="display:none;">
            <h2>Carton Details</h2>
            <form id="carton-details-form">
                <div class="form-group">
                    <label for="carton-subunit-type">What's inside the carton?</label>
                    <select id="carton-subunit-type" required>
                         <option value="" disabled selected>Select a unit...</option>
                         <option value="sachets">sachets</option>
                         <option value="bottles">bottles</option>
                         <option value="cans">cans</option>
                         <option value="pieces">pieces</option>
                         <option value="packs">packs</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="carton-subunit-quantity" id="carton-quantity-label">Quantity of items per carton</label>
                    <input type="text" id="carton-subunit-quantity" inputmode="numeric" required>
                </div>
                <div class="modal-actions">
                     <button type="button" id="cancel-carton-details-btn" class="btn btn-secondary">Cancel</button>
                     <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>

        <div id="confirm-sale-modal" class="modal-content" style="display:none;">
            <h2>Confirm Sale</h2>
            <div class="sale-item-details"><img id="sale-product-image" src="" alt="Product image"><div><h3 id="sale-product-name">Product Name</h3><p id="sale-product-stock">Stock: 50 sachets</p></div></div>
            <div class="form-group"><label for="sale-quantity">Quantity</label><input type="text" id="sale-quantity" inputmode="numeric" value="1" min="1"></div>
            <div class="sale-total"><p>Total</p><h2 id="sale-total-price">₦0</h2></div>
            <div class="modal-actions modal-actions-inline">
                <button id="cancel-sale-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-sale-btn" class="btn btn-primary">Confirm Sale</button>
            </div>
        </div>

        <div id="receipt-modal" class="modal-content receipt-modal" style="display:none;">
            <div id="receipt-content" class="receipt-paper">
                </div>
            <div class="modal-actions modal-actions-inline">
                <button id="close-receipt-btn" class="btn btn-secondary">Close</button>
                <button id="print-receipt-btn" class="btn btn-secondary">Print Receipt</button>
                <button id="share-receipt-btn" class="btn btn-primary">Share</button>
            </div>
        </div>
        
        <div id="entry-choice-modal" class="modal-content" style="display:none;">
            <h2 id="entry-choice-title">New Sale Entry</h2>
            <p id="entry-choice-p">How would you like to log this sale?</p>
            <div class="modal-actions">
                <button id="retry-sell-scan-btn" class="btn btn-secondary" style="display: none;">Try Again</button>
                <button id="manual-entry-btn" class="btn btn-secondary">Manual Entry</button>
                <button id="select-from-products-btn" class="btn btn-primary">Select from Products</button>
            </div>
             <button type="button" id="cancel-entry-choice-btn" class="btn btn-secondary" style="margin-top: 12px;">Cancel</button>
        </div>

        <div id="manual-sale-modal" class="modal-content" style="display:none;">
            <h2>Manual Sale</h2>
            <form id="manual-sale-form">
                <div class="form-group"><label for="manual-product-name">Product Name</label><input type="text" id="manual-product-name" required></div>
                <div class="form-group"><label for="manual-product-price">Selling Price (₦)</label><input type="text" id="manual-product-price" inputmode="decimal" required></div>
                <div class="form-group"><label for="manual-sale-quantity">Quantity</label><input type="text" id="manual-sale-quantity" value="1" inputmode="numeric" required></div>
                <div class="form-group"><label for="manual-product-unit">Unit Type</label><select id="manual-product-unit" required><option value="pieces">pieces</option><option value="sachets">sachets</option><option value="bottles">bottles</option><option value="cans">cans</option><option value="packs">packs</option></select></div>
                <div class="modal-actions">
                    <button type="button" id="cancel-manual-sale-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Sale</button>
                </div>
            </form>
        </div>

        <div id="qr-code-modal" class="modal-content" style="display:none;">
            <h2>Share Log via QR</h2>
            <canvas id="qr-canvas"></canvas>
            <p class="qr-help-text">Have the other retailer scan this QR code using their pika shot app to log this purchase.</p>
            <div class="modal-actions">
                <button id="close-qr-btn" class="btn btn-primary">Done</button>
            </div>
        </div>
        
        <div id="confirm-log-modal" class="modal-content" style="display:none;">
            <h2 id="confirm-log-title">Accept Log?</h2>
            <div id="confirm-log-content"></div>
            <div class="modal-actions">
                <button id="reject-log-btn" class="btn btn-secondary">Reject</button>
                <button id="accept-log-btn" class="btn btn-primary">Accept & Add</button>
            </div>
        </div>

        <div id="privacy-policy-modal" class="modal-content" style="display:none;">
            <h2>Data & Privacy Policy</h2>
            <p style="text-align: left;">
                Hey there! To make pika-shot work smoothly, we save your business details (like your name, phone number, and location) and product data right on your device. We only use your location and business type to gather general insights that help us improve the app for everyone. Your data is for your benefit, helping you track everything effortlessly.
            </p>
            <div class="modal-actions">
                <button id="privacy-ok-btn" class="btn btn-primary">Got it</button>
            </div>
        </div>

    </div>

    <script src="db.js"></script>
    <script src="camera.js"></script>
    <script src="app.js"></script>
</body>
</html>